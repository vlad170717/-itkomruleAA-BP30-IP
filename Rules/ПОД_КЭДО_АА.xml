<ПравилаОбмена>
	<ВерсияФормата РежимСовместимости="РежимСовместимостиСБСП20">2.01</ВерсияФормата>
	<Ид>8158d517-3457-40e0-af9a-cfd3a37db176    </Ид>
	<Наименование>КлиентЭДОБазовая 2.9 --&gt; Автосалон5.1.23</Наименование>
	<ДатаВремяСоздания>2022-07-18T15:56:42</ДатаВремяСоздания>
	<Источник ВерсияПлатформы="8.0" ВерсияКонфигурации="2.9.4.31" СинонимКонфигурации="Клиент ЭДО (базовая), редакция 2.9">КлиентЭДОБазовая</Источник>
	<Приемник ВерсияПлатформы="8.0" ВерсияКонфигурации="5.1.23.04" СинонимКонфигурации="Альфа-Авто: Автосалон+Автосервис+Автозапчасти ПРОФ, редакция 5.1">Автосалон5</Приемник>
	<ПослеЗагрузкиПравилОбмена>
ВерсияПравил	= "//#%#027#%%#";
ВерсияПравил	= СтрЗаменить(ВерсияПравил, "//#%#","");
ВерсияПравил	= СтрЗаменить(ВерсияПравил, "#%%#","");
Сообщить("Версия правил " + ВерсияПравил);
</ПослеЗагрузкиПравилОбмена>
	<ПослеЗагрузкиПараметров>Параметры.ПодразделениеИП = Справочники.ПодразделенияКомпании.НайтиПоКоду("ЦБ000005");
Параметры.ПодразделениеООО = Справочники.ПодразделенияКомпании.НайтиПоКоду("ЦБ000008");</ПослеЗагрузкиПараметров>
	<Параметры>
		<Параметр Имя="ПодразделениеИП                                   " Наименование="ПодразделениеИП                                   " ИспользуетсяПриЗагрузке="true" УстанавливатьВДиалоге="true" ТипЗначения="Строка" ПередаватьПараметрПриВыгрузке="true"/>
		<Параметр Имя="ПодразделениеООО                                  " Наименование="ПодразделениеООО                                  " ИспользуетсяПриЗагрузке="true" УстанавливатьВДиалоге="true" ТипЗначения="Строка" ПередаватьПараметрПриВыгрузке="true"/>
	</Параметры>
	<Обработки/>
	<ПравилаКонвертацииОбъектов>
		<Группа>
			<Код>Документы</Код>
			<Наименование>Документы</Наименование>
			<Порядок>50</Порядок>
			<Правило>
				<Код>ПоступлениеТоваров</Код>
				<Наименование>Документ: Поступление (акты, накладные)</Наименование>
				<Порядок>50</Порядок>
				<ПослеЗагрузки>Если НЕ ЗначениеЗаполнено(Объект.Автор) Тогда
	Объект.Автор = ПараметрыСеанса.Пользователь;
КонецЕсли;

Если Объект.Организация.ФормаСобственности = Перечисления.ФормыСобственности.ЮридическоеЛицо Тогда
	Объект.ПодразделениеКомпании = Параметры.ПодразделениеООО;
	Объект.амбООО = Истина;
Иначе
	Объект.ПодразделениеКомпании = Параметры.ПодразделениеИП;
КонецЕсли;
Объект.ВалютаДокумента = Константы.ВалютаРегламентированногоУчетаОрганизаций.Получить();

Объект.ТипЦен = Справочники.ТипыЦен.ОсновнойТипЦенЗакупки;
Объект.ХозОперация = Справочники.ХозОперации.ПоступлениеТоваров;
Объект.ЗакрытиеЗаказовПоПодразделению = Перечисления.ВариантыОтветов.Нет;
Объект.ДоговорВзаиморасчетов = Справочники.Контрагенты.ПолучитьДоговорВзаиморасчетов(Объект.Контрагент, Перечисления.ВидыДоговоров.Покупка, Объект);

//--------------------------------------------------------
Выполнить(Алгоритмы.ЗаполнитьЕдиницыИзмеренияГТД);

Объект.Проведен = Ложь;

ТипЦенВключаетНДС = Объект.ТипЦен.ЦенаВключаетНДС;

Для Каждого ТекущаяСтрока Из Объект.Товары Цикл
	
	Если НЕ ЗначениеЗаполнено(ТекущаяСтрока.ИдентификаторТовара) Тогда
		ТекущаяСтрока.ИдентификаторТовара = Новый УникальныйИдентификатор;
	КонецЕсли;
	
	ТекущаяСтрока.СуммаВсего = ТекущаяСтрока.Сумма + ТекущаяСтрока.СуммаНДС;
	
	Если ТипЦенВключаетНДС Тогда
		ТекущаяСтрока.Сумма = ТекущаяСтрока.Сумма + ТекущаяСтрока.СуммаНДС;
		ТекущаяСтрока.Цена  = ?(ТекущаяСтрока.Количество = 0, 0, ТекущаяСтрока.Сумма / ТекущаяСтрока.Количество);
	КонецЕсли;
	
КонецЦикла;</ПослеЗагрузки>
				<Источник>ДокументСсылка.ПоступлениеТоваровУслуг</Источник>
				<Приемник>ДокументСсылка.ПоступлениеТоваров</Приемник>
				<Свойства>
					<Свойство Поиск="true">
						<Код>1</Код>
						<Наименование>Дата --&gt; Дата</Наименование>
						<Порядок>50</Порядок>
						<Источник Имя="Дата" Вид="Свойство" Тип="Дата"/>
						<Приемник Имя="Дата" Вид="Свойство" Тип="Дата"/>
					</Свойство>
					<Свойство>
						<Код>2</Код>
						<Наименование>ДокументОснование --&gt; ДокументОснование</Наименование>
						<Порядок>100</Порядок>
						<Источник Имя="ДокументОснование" Вид="Реквизит" Тип="ДокументСсылка.ПоступлениеТоваровУслуг"/>
						<Приемник Имя="ДокументОснование" Вид="Реквизит"/>
					</Свойство>
					<Свойство>
						<Код>3</Код>
						<Наименование>Комментарий --&gt; Комментарий</Наименование>
						<Порядок>150</Порядок>
						<Источник Имя="Комментарий" Вид="Реквизит" Тип="Строка"/>
						<Приемник Имя="Комментарий" Вид="Реквизит" Тип="Строка"/>
					</Свойство>
					<Свойство>
						<Код>4</Код>
						<Наименование>Контрагент --&gt; Контрагент</Наименование>
						<Порядок>200</Порядок>
						<Источник Имя="Контрагент" Вид="Реквизит" Тип="СправочникСсылка.Контрагенты"/>
						<Приемник Имя="Контрагент" Вид="Реквизит" Тип="СправочникСсылка.Контрагенты"/>
						<КодПравилаКонвертации>Контрагенты                                       </КодПравилаКонвертации>
					</Свойство>
					<Свойство Поиск="true">
						<Код>5</Код>
						<Наименование>Номер --&gt; Номер</Наименование>
						<Порядок>250</Порядок>
						<Источник Имя="Номер" Вид="Свойство" Тип="Строка"/>
						<Приемник Имя="Номер" Вид="Свойство" Тип="Строка"/>
						<ПриводитьКДлине>10</ПриводитьКДлине>
					</Свойство>
					<Свойство>
						<Код>6</Код>
						<Наименование>Организация --&gt; Организация</Наименование>
						<Порядок>300</Порядок>
						<Источник Имя="Организация" Вид="Реквизит" Тип="СправочникСсылка.Организации"/>
						<Приемник Имя="Организация" Вид="Реквизит" Тип="СправочникСсылка.Организации"/>
						<КодПравилаКонвертации>Организации                                       </КодПравилаКонвертации>
					</Свойство>
					<Свойство>
						<Код>7</Код>
						<Наименование>ПометкаУдаления --&gt; ПометкаУдаления</Наименование>
						<Порядок>350</Порядок>
						<Источник Имя="ПометкаУдаления" Вид="Свойство" Тип="Булево"/>
						<Приемник Имя="ПометкаУдаления" Вид="Свойство" Тип="Булево"/>
					</Свойство>
					<Свойство Отключить="true">
						<Код>8</Код>
						<Наименование>Проведен --&gt; Проведен</Наименование>
						<Порядок>400</Порядок>
						<Источник Имя="Проведен" Вид="Свойство" Тип="Булево"/>
						<Приемник Имя="Проведен" Вид="Свойство" Тип="Булево"/>
					</Свойство>
					<Свойство>
						<Код>9</Код>
						<Наименование>СуммаДокумента --&gt; СуммаДокумента</Наименование>
						<Порядок>450</Порядок>
						<Источник Имя="СуммаДокумента" Вид="Реквизит" Тип="Число"/>
						<Приемник Имя="СуммаДокумента" Вид="Реквизит" Тип="Число"/>
					</Свойство>
					<Группа>
						<Код>10</Код>
						<Наименование>Товары --&gt; Товары</Наименование>
						<Порядок>500</Порядок>
						<Источник Имя="Товары" Вид="ТабличнаяЧасть"/>
						<Приемник Имя="Товары" Вид="ТабличнаяЧасть"/>
						<Свойство>
							<Код>11</Код>
							<Наименование>ЕдиницаИзмерения --&gt; ЕдиницаИзмерения</Наименование>
							<Порядок>50</Порядок>
							<Источник Имя="ЕдиницаИзмерения" Вид="Реквизит" Тип="СправочникСсылка.ЕдиницыИзмерения"/>
							<Приемник Имя="ЕдиницаИзмерения" Вид="Реквизит" Тип="СправочникСсылка.ЕдиницыИзмерения"/>
							<КодПравилаКонвертации>ЕдиницыИзмерения                                  </КодПравилаКонвертации>
						</Свойство>
						<Свойство>
							<Код>12</Код>
							<Наименование>Количество --&gt; Количество</Наименование>
							<Порядок>100</Порядок>
							<Источник Имя="Количество" Вид="Реквизит" Тип="Число"/>
							<Приемник Имя="Количество" Вид="Реквизит" Тип="Число"/>
						</Свойство>
						<Свойство>
							<Код>13</Код>
							<Наименование>Номенклатура --&gt; Номенклатура</Наименование>
							<Порядок>150</Порядок>
							<Источник Имя="Номенклатура" Вид="Реквизит" Тип="СправочникСсылка.Номенклатура"/>
							<Приемник Имя="Номенклатура" Вид="Реквизит" Тип="СправочникСсылка.Номенклатура"/>
							<КодПравилаКонвертации>Номенклатура                                      </КодПравилаКонвертации>
						</Свойство>
						<Свойство>
							<Код>14</Код>
							<Наименование>СтавкаНДС --&gt; СтавкаНДС</Наименование>
							<Порядок>200</Порядок>
							<Источник Имя="СтавкаНДС" Вид="Реквизит" Тип="ПеречислениеСсылка.СтавкиНДС"/>
							<Приемник Имя="СтавкаНДС" Вид="Реквизит" Тип="СправочникСсылка.СтавкиНДС"/>
						</Свойство>
						<Свойство>
							<Код>15</Код>
							<Наименование>Сумма --&gt; Сумма</Наименование>
							<Порядок>250</Порядок>
							<Источник Имя="Сумма" Вид="Реквизит" Тип="Число"/>
							<Приемник Имя="Сумма" Вид="Реквизит" Тип="Число"/>
						</Свойство>
						<Свойство>
							<Код>16</Код>
							<Наименование>СуммаНДС --&gt; СуммаНДС</Наименование>
							<Порядок>300</Порядок>
							<Источник Имя="СуммаНДС" Вид="Реквизит" Тип="Число"/>
							<Приемник Имя="СуммаНДС" Вид="Реквизит" Тип="Число"/>
						</Свойство>
						<Свойство>
							<Код>17</Код>
							<Наименование>Цена --&gt; Цена</Наименование>
							<Порядок>350</Порядок>
							<Источник Имя="Цена" Вид="Реквизит" Тип="Число"/>
							<Приемник Имя="Цена" Вид="Реквизит" Тип="Число"/>
						</Свойство>
					</Группа>
					<Свойство Отключить="true">
						<Код>18</Код>
						<Наименование>--&gt; Автор</Наименование>
						<Порядок>550</Порядок>
						<Источник Имя="" Вид=""/>
						<Приемник Имя="Автор" Вид="Реквизит" Тип="СправочникСсылка.Пользователи"/>
					</Свойство>
					<Свойство>
						<Код>19</Код>
						<Наименование>--&gt; РегламентированныйУчет</Наименование>
						<Порядок>600</Порядок>
						<Источник Имя="" Вид=""/>
						<Приемник Имя="РегламентированныйУчет" Вид="Реквизит" Тип="Булево"/>
						<ПередВыгрузкой>Значение = Истина;</ПередВыгрузкой>
					</Свойство>
					<Свойство>
						<Код>20</Код>
						<Наименование>ДатаЭД --&gt; ВхДокДата</Наименование>
						<Порядок>650</Порядок>
						<Источник Имя="ДатаЭД" Вид="Реквизит" Тип="Дата"/>
						<Приемник Имя="ВхДокДата" Вид="Реквизит" Тип="Дата"/>
					</Свойство>
					<Свойство>
						<Код>21</Код>
						<Наименование>НомерЭД --&gt; ВхДокНомер</Наименование>
						<Порядок>700</Порядок>
						<Источник Имя="НомерЭД" Вид="Реквизит" Тип="Строка"/>
						<Приемник Имя="ВхДокНомер" Вид="Реквизит" Тип="Строка"/>
					</Свойство>
					<Свойство>
						<Код>22</Код>
						<Наименование>--&gt; КурсВалютыВзаиморасчетов</Наименование>
						<Порядок>750</Порядок>
						<Источник Имя="" Вид=""/>
						<Приемник Имя="КурсВалютыВзаиморасчетов" Вид="Реквизит" Тип="Число"/>
						<ПередВыгрузкой>Значение = 1;</ПередВыгрузкой>
					</Свойство>
					<Свойство>
						<Код>23</Код>
						<Наименование>--&gt; КурсДокумента</Наименование>
						<Порядок>800</Порядок>
						<Источник Имя="" Вид=""/>
						<Приемник Имя="КурсДокумента" Вид="Реквизит" Тип="Число"/>
						<ПередВыгрузкой>Значение = 1;</ПередВыгрузкой>
					</Свойство>
					<Свойство>
						<Код>24</Код>
						<Наименование>--&gt; КурсВалютыУпр</Наименование>
						<Порядок>850</Порядок>
						<Источник Имя="" Вид=""/>
						<Приемник Имя="КурсВалютыУпр" Вид="Реквизит" Тип="Число"/>
						<ПередВыгрузкой>Значение = 1;</ПередВыгрузкой>
					</Свойство>
				</Свойства>
				<Значения/>
			</Правило>
		</Группа>
		<Группа>
			<Код>Справочники</Код>
			<Наименование>Справочники</Наименование>
			<Порядок>100</Порядок>
			<Правило>
				<Код>Контрагенты</Код>
				<Наименование>Справочник: Контрагенты</Наименование>
				<Порядок>50</Порядок>
				<НеСоздаватьЕслиНеНайден>true</НеСоздаватьЕслиНеНайден>
				<Источник>СправочникСсылка.Контрагенты</Источник>
				<Приемник>СправочникСсылка.Контрагенты</Приемник>
				<Свойства>
					<Свойство>
						<Код>1</Код>
						<Наименование>Код --&gt; Код</Наименование>
						<Порядок>50</Порядок>
						<Источник Имя="Код" Вид="Свойство" Тип="Строка"/>
						<Приемник Имя="Код" Вид="Свойство" Тип="Строка"/>
						<ПриводитьКДлине>8</ПриводитьКДлине>
					</Свойство>
					<Свойство>
						<Код>2</Код>
						<Наименование>Наименование --&gt; Наименование</Наименование>
						<Порядок>100</Порядок>
						<Источник Имя="Наименование" Вид="Свойство" Тип="Строка"/>
						<Приемник Имя="Наименование" Вид="Свойство" Тип="Строка"/>
					</Свойство>
					<Свойство>
						<Код>3</Код>
						<Наименование>Родитель --&gt; Родитель</Наименование>
						<Порядок>150</Порядок>
						<Источник Имя="Родитель" Вид="Свойство" Тип="СправочникСсылка.Контрагенты"/>
						<Приемник Имя="Родитель" Вид="Свойство" Тип="СправочникСсылка.Контрагенты"/>
						<КодПравилаКонвертации>Контрагенты                                       </КодПравилаКонвертации>
					</Свойство>
					<Свойство Поиск="true" Обязательное="true">
						<Код>4</Код>
						<Наименование>ЭтоГруппа --&gt; ЭтоГруппа</Наименование>
						<Порядок>200</Порядок>
						<Источник Имя="ЭтоГруппа" Вид="Свойство" Тип="Булево"/>
						<Приемник Имя="ЭтоГруппа" Вид="Свойство" Тип="Булево"/>
					</Свойство>
					<Свойство Поиск="true">
						<Код>5</Код>
						<Наименование>ИНН --&gt; ИНН</Наименование>
						<Порядок>250</Порядок>
						<Источник Имя="ИНН" Вид="Реквизит" Тип="Строка"/>
						<Приемник Имя="ИНН" Вид="Реквизит" Тип="Строка"/>
					</Свойство>
				</Свойства>
				<Значения/>
			</Правило>
			<Правило>
				<Код>Организации</Код>
				<Наименование>Справочник: Организации</Наименование>
				<Порядок>100</Порядок>
				<НеСоздаватьЕслиНеНайден>true</НеСоздаватьЕслиНеНайден>
				<Источник>СправочникСсылка.Организации</Источник>
				<Приемник>СправочникСсылка.Организации</Приемник>
				<Свойства>
					<Свойство>
						<Код>1</Код>
						<Наименование>Код --&gt; Код</Наименование>
						<Порядок>50</Порядок>
						<Источник Имя="Код" Вид="Свойство" Тип="Строка"/>
						<Приемник Имя="Код" Вид="Свойство" Тип="Строка"/>
						<ПриводитьКДлине>8</ПриводитьКДлине>
					</Свойство>
					<Свойство>
						<Код>2</Код>
						<Наименование>Наименование --&gt; Наименование</Наименование>
						<Порядок>100</Порядок>
						<Источник Имя="Наименование" Вид="Свойство" Тип="Строка"/>
						<Приемник Имя="Наименование" Вид="Свойство" Тип="Строка"/>
					</Свойство>
					<Свойство Поиск="true">
						<Код>3</Код>
						<Наименование>ИНН --&gt; ИНН</Наименование>
						<Порядок>150</Порядок>
						<Источник Имя="ИНН" Вид="Реквизит" Тип="Строка"/>
						<Приемник Имя="ИНН" Вид="Реквизит" Тип="Строка"/>
					</Свойство>
				</Свойства>
				<Значения/>
			</Правило>
			<Правило>
				<Код>ЕдиницыИзмерения</Код>
				<Наименование>Справочник: Единицы измерения</Наименование>
				<Порядок>150</Порядок>
				<НеСоздаватьЕслиНеНайден>true</НеСоздаватьЕслиНеНайден>
				<Источник>СправочникСсылка.ЕдиницыИзмерения</Источник>
				<Приемник>СправочникСсылка.ЕдиницыИзмерения</Приемник>
				<Свойства>
					<Свойство Поиск="true">
						<Код>1</Код>
						<Наименование>Код --&gt; Код</Наименование>
						<Порядок>50</Порядок>
						<Источник Имя="Код" Вид="Свойство" Тип="Строка"/>
						<Приемник Имя="Код" Вид="Свойство" Тип="Строка"/>
					</Свойство>
					<Свойство>
						<Код>2</Код>
						<Наименование>Наименование --&gt; Наименование</Наименование>
						<Порядок>100</Порядок>
						<Источник Имя="Наименование" Вид="Свойство" Тип="Строка"/>
						<Приемник Имя="Наименование" Вид="Свойство" Тип="Строка"/>
					</Свойство>
					<Свойство>
						<Код>3</Код>
						<Наименование>--&gt; Владелец</Наименование>
						<Порядок>150</Порядок>
						<Источник Имя="" Вид=""/>
						<Приемник Имя="Владелец" Вид="Свойство"/>
					</Свойство>
				</Свойства>
				<Значения/>
			</Правило>
			<Правило>
				<Код>Номенклатура</Код>
				<Наименование>Справочник: Номенклатура</Наименование>
				<Порядок>200</Порядок>
				<НеСоздаватьЕслиНеНайден>true</НеСоздаватьЕслиНеНайден>
				<Источник>СправочникСсылка.Номенклатура</Источник>
				<Приемник>СправочникСсылка.Номенклатура</Приемник>
				<Свойства>
					<Свойство Поиск="true">
						<Код>1</Код>
						<Наименование>Код --&gt; Код</Наименование>
						<Порядок>50</Порядок>
						<Источник Имя="Код" Вид="Свойство" Тип="Строка"/>
						<Приемник Имя="Код" Вид="Свойство" Тип="Строка"/>
						<ПриводитьКДлине>8</ПриводитьКДлине>
					</Свойство>
					<Свойство>
						<Код>2</Код>
						<Наименование>Наименование --&gt; Наименование</Наименование>
						<Порядок>100</Порядок>
						<Источник Имя="Наименование" Вид="Свойство" Тип="Строка"/>
						<Приемник Имя="Наименование" Вид="Свойство" Тип="Строка"/>
					</Свойство>
					<Свойство>
						<Код>3</Код>
						<Наименование>Родитель --&gt; Родитель</Наименование>
						<Порядок>150</Порядок>
						<Источник Имя="Родитель" Вид="Свойство" Тип="СправочникСсылка.Номенклатура"/>
						<Приемник Имя="Родитель" Вид="Свойство" Тип="СправочникСсылка.Номенклатура"/>
						<КодПравилаКонвертации>Номенклатура                                      </КодПравилаКонвертации>
					</Свойство>
					<Свойство Поиск="true" Обязательное="true">
						<Код>4</Код>
						<Наименование>ЭтоГруппа --&gt; ЭтоГруппа</Наименование>
						<Порядок>200</Порядок>
						<Источник Имя="ЭтоГруппа" Вид="Свойство" Тип="Булево"/>
						<Приемник Имя="ЭтоГруппа" Вид="Свойство" Тип="Булево"/>
					</Свойство>
				</Свойства>
				<Значения/>
			</Правило>
		</Группа>
	</ПравилаКонвертацииОбъектов>
	<ПравилаВыгрузкиДанных>
		<Группа Отключить="false">
			<Код>Документы</Код>
			<Наименование>Документы</Наименование>
			<Порядок>50</Порядок>
			<Правило Отключить="false">
				<Код>ПоступлениеТоваровУслуг</Код>
				<Наименование>ПоступлениеТоваровУслуг</Наименование>
				<Порядок>50</Порядок>
				<КодПравилаКонвертации>ПоступлениеТоваров                                </КодПравилаКонвертации>
				<СпособОтбораДанных>СтандартнаяВыборка</СпособОтбораДанных>
				<ОбъектВыборки>ДокументСсылка.ПоступлениеТоваровУслуг</ОбъектВыборки>
			</Правило>
		</Группа>
	</ПравилаВыгрузкиДанных>
	<ПравилаОчисткиДанных/>
	<Алгоритмы>
		<Алгоритм Имя="ЗаполнитьЕдиницыИзмеренияГТД" ИспользуетсяПриЗагрузке="true">
			<Текст>ТаблицаПараметров = ?(ПараметрыОбъекта &lt;&gt; Неопределено, ПараметрыОбъекта.Получить("ТоварыТабличнаяЧасть"), ПараметрыОбъекта);

Если ТаблицаПараметров &lt;&gt; Неопределено Тогда
	
	ТаблицаЕдиницыИзмеренияГТД = Новый ТаблицаЗначений;
	ТаблицаЕдиницыИзмеренияГТД.Колонки.Добавить("НомерСтроки", Новый ОписаниеТипов("Число"));
	ТаблицаЕдиницыИзмеренияГТД.Колонки.Добавить("КодЕдиницыИзмеренияПоКлассификатору", Новый ОписаниеТипов("Строка", , Новый КвалификаторыСтроки(4)));
	ТаблицаЕдиницыИзмеренияГТД.Колонки.Добавить("НомерГТД", Новый ОписаниеТипов("Строка", , Новый КвалификаторыСтроки(200)));
	Для Каждого СтрокаПараметров Из ТаблицаПараметров Цикл
		НоваяСтрока = ТаблицаЕдиницыИзмеренияГТД.Добавить();
		НоваяСтрока.НомерСтроки = СтрокаПараметров.НомерСтроки + 1;
		НоваяСтрока.КодЕдиницыИзмеренияПоКлассификатору = СтрокаПараметров.КодЕдиницыИзмеренияПоКлассификатору;
		НоваяСтрока.НомерГТД = СтрокаПараметров.НомерГТД;
	КонецЦикла;
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	ТаблицаЕдиницыИзмерения.НомерСтроки КАК НомерСтроки,
		|	ТаблицаЕдиницыИзмерения.КодЕдиницыИзмеренияПоКлассификатору КАК КодЕдиницыИзмеренияПоКлассификатору,
		|	ТаблицаЕдиницыИзмерения.НомерГТД КАК НомерГТД
		|ПОМЕСТИТЬ ВТ_ЕдиницыИзмерения
		|ИЗ
		|	&amp;ТаблицаЕдиницыИзмерения КАК ТаблицаЕдиницыИзмерения
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ТаблицаТовары.НомерСтроки КАК НомерСтроки,
		|	ТаблицаТовары.Номенклатура КАК Номенклатура
		|ПОМЕСТИТЬ ВТ_Товары
		|ИЗ
		|	&amp;ТаблицаТовары КАК ТаблицаТовары
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ВТ_Товары.НомерСтроки КАК НомерСтроки,
		|	ВТ_Товары.Номенклатура КАК Номенклатура,
		|	ЕСТЬNULL(ЕдиницыИзмерения.Ссылка, Неопределено) КАК ЕдиницаИзмерения,
		|	ЕСТЬNULL(ЕдиницыИзмерения.Коэффициент, 0) КАК Коэффициент,
		|	ЕСТЬNULL(КлассификаторЕдиницИзмерения.Ссылка, Неопределено) КАК Классификатор
		|ИЗ
		|	ВТ_Товары КАК ВТ_Товары
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТ_ЕдиницыИзмерения КАК ВТ_ЕдиницыИзмерения
		|		ПО ВТ_Товары.НомерСтроки = ВТ_ЕдиницыИзмерения.НомерСтроки
		|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.КлассификаторЕдиницИзмерения КАК КлассификаторЕдиницИзмерения
		|		ПО (ВТ_ЕдиницыИзмерения.КодЕдиницыИзмеренияПоКлассификатору = КлассификаторЕдиницИзмерения.Код)
		|			И (НЕ КлассификаторЕдиницИзмерения.ПометкаУдаления)
		|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ЕдиницыИзмерения КАК ЕдиницыИзмерения
		|		ПО (ВТ_Товары.Номенклатура = ЕдиницыИзмерения.Владелец ИЛИ ВТ_Товары.Номенклатура.ТипНоменклатуры = ЕдиницыИзмерения.Владелец)
		|			И (КлассификаторЕдиницИзмерения.Ссылка = ЕдиницыИзмерения.ЕдиницаПоКлассификатору)
		|			И (НЕ ЕдиницыИзмерения.ПометкаУдаления)
		|
		|УПОРЯДОЧИТЬ ПО
		|	НомерСтроки
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ВТ_Товары.НомерСтроки КАК НомерСтроки,
		|	ВТ_Товары.Номенклатура КАК Номенклатура,
		|	ЕСТЬNULL(ГТД.Ссылка, Неопределено) КАК ГТД,
		|	ВТ_ЕдиницыИзмерения.НомерГТД КАК НомерГТД
		|ИЗ
		|	ВТ_Товары КАК ВТ_Товары
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТ_ЕдиницыИзмерения КАК ВТ_ЕдиницыИзмерения
		|			ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ГТД КАК ГТД
		|			ПО (ВТ_ЕдиницыИзмерения.НомерГТД = ГТД.Наименование
		|					И НЕ ГТД.ПометкаУдаления)
		|		ПО ВТ_Товары.НомерСтроки = ВТ_ЕдиницыИзмерения.НомерСтроки";	
	Запрос.УстановитьПараметр("ТаблицаЕдиницыИзмерения", ТаблицаЕдиницыИзмеренияГТД);
	Запрос.УстановитьПараметр("ТаблицаТовары", Объект.Товары.Выгрузить(,"НомерСтроки, Номенклатура"));
	
	ПакетЗапрос = Запрос.ВыполнитьПакет();
	Выборка = ПакетЗапрос[2].Выбрать();
	
	Пока Выборка.СледующийПоЗначениюПоля("НомерСтроки") Цикл
		СтрокаТаблицы = Объект.Товары[Выборка.НомерСтроки - 1];
		Если ЗначениеЗаполнено(Выборка.ЕдиницаИзмерения) Тогда
			СтрокаТаблицы.ЕдиницаИзмерения = Выборка.ЕдиницаИзмерения;
			СтрокаТаблицы.Коэффициент      = Выборка.Коэффициент;
		ИначеЕсли ЗначениеЗаполнено(Выборка.Классификатор) Тогда
			//ЕдиницаИзмерения = ЕдиницаИзмеренияНоменклатуры(СтрокаТаблицы.Номенклатура, Выборка.Классификатор);
			ЕдиницаИзмерения = неопределено;
			// посмотрим как у нас хранятся единицы измерения
			Если СтрокаТаблицы.Номенклатура.ТипНоменклатуры.ИспользованиеЕдиницИзмерения=1 Тогда // подчинены типу номенклатуры
				ВладелецЕдиниц = СтрокаТаблицы.Номенклатура.ТипНоменклатуры;
			Иначе // подчинены номенклатуре
				ВладелецЕдиниц = СтрокаТаблицы.Номенклатура;
			КонецЕсли;
			
			Если НЕ ЗначениеЗаполнено(ВладелецЕдиниц) Тогда
				Продолжить;
			КонецЕсли;
			
			// ищем единицу
			Запрос = Новый Запрос("ВЫБРАТЬ ПЕРВЫЕ 1
			|	ЕдиницыИзмерения.Ссылка,
			|	ЕдиницыИзмерения.Коэффициент КАК Коэффициент,
			|	ВЫБОР
			|		КОГДА ЕдиницыИзмерения.Наименование = &amp;ЕдиницаПоКлассификатору ТОГДА
			|			0
			|		ИНАЧЕ
			|			1
			|	КОНЕЦ КАК ПолеСортировки
			|ИЗ
			|	Справочник.ЕдиницыИзмерения КАК ЕдиницыИзмерения
			|ГДЕ
			|	ЕдиницыИзмерения.Владелец = &amp;ВладелецЕдиниц И 
			|	ЕдиницыИзмерения.ПометкаУдаления = ЛОЖЬ И 
			|	ЕдиницыИзмерения.ЕдиницаПоКлассификатору = &amp;БазоваяЕдиницаИзмерения
			|УПОРЯДОЧИТЬ ПО
			|	Коэффициент ВОЗР,
			|	ПолеСортировки ВОЗР
			|");
			
			Запрос.УстановитьПараметр("ВладелецЕдиниц",          ВладелецЕдиниц);
			Запрос.УстановитьПараметр("БазоваяЕдиницаИзмерения", Выборка.Классификатор);
			Запрос.УстановитьПараметр("ЕдиницаПоКлассификатору", Выборка.Классификатор.Наименование);
			Выборка = Запрос.Выполнить().Выбрать();
			// если нашли, то вернем единицу, иначе создадим новую
			Если Выборка.Следующий() Тогда
				ЕдиницаИзмерения = Выборка.Ссылка;
			Иначе
				// не нашли - создаем новую
				НоваяЕдиница=Справочники.ЕдиницыИзмерения.СоздатьЭлемент();
				НоваяЕдиница.Владелец=ВладелецЕдиниц;
				НоваяЕдиница.УстановитьНовыйКод("");
				НоваяЕдиница.ЕдиницаПоКлассификатору=Выборка.Классификатор;
				НоваяЕдиница.Коэффициент=1;
				НоваяЕдиница.Точность=2;
				НоваяЕдиница.Наименование=СокрЛП(Выборка.Классификатор);
				// ++ Alexku 02.02.2016
				Если СтрокаТаблицы.Номенклатура.ТипНоменклатуры.ИспользованиеЕдиницИзмерения = 2 Тогда
					// подчинены номенклатуре
					// перенесем вес и объем из карточки номенклатуры в основную единицу измерения
					НоваяЕдиница.Вес = СтрокаТаблицы.Номенклатура.Вес;
					НоваяЕдиница.Объем = СтрокаТаблицы.Номенклатура.Объем;
					ЭтотОбъект.Вес = 0;
					ЭтотОбъект.Объем = 0;
				КонецЕсли;
				// -- Alexku 
				НоваяЕдиница.Записать();
				ЕдиницаИзмерения = НоваяЕдиница.Ссылка;
			КонецЕсли;
			
			СтрокаТаблицы.ЕдиницаИзмерения = ЕдиницаИзмерения;
			СтрокаТаблицы.Коэффициент      = ЕдиницаИзмерения.Коэффициент;
		Иначе
			СтрокаТаблицы.ЕдиницаИзмерения = СтрокаТаблицы.Номенклатура.ОсновнаяЕдиницаИзмерения;
			СтрокаТаблицы.Коэффициент = СтрокаТаблицы.Номенклатура.ОсновнаяЕдиницаИзмерения.Коэффициент;
		КонецЕсли;
	КонецЦикла;
	
	Выборка = ПакетЗапрос[3].Выбрать();
	
	Пока Выборка.СледующийПоЗначениюПоля("НомерСтроки") Цикл
		СтрокаТаблицы = Объект.Товары[Выборка.НомерСтроки - 1];
		Если ЗначениеЗаполнено(Выборка.ГТД) Тогда
			СтрокаТаблицы.ГТД = Выборка.ГТД;
		ИначеЕсли ЗначениеЗаполнено(Выборка.НомерГТД) Тогда
			ГТД = Справочники.ГТД.СоздатьЭлемент();
			ГТД.Наименование = Выборка.НомерГТД;
			ГТД.Записать();
			СтрокаТаблицы.ГТД = ГТД;
		КонецЕсли;
	КонецЦикла;	
	
КонецЕсли;</Текст>
			<Параметры>Объект</Параметры>
		</Алгоритм>
	</Алгоритмы>
	<Запросы/>
</ПравилаОбмена>